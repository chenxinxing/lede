name: build OpenWrt WNDR4300V1
on: 
  push:
  schedule:
  - cron: 0 0 * * 5
  #watch:
  #  types: started
  
#env:
#  REPO_URL: https://github.com/coolsnowwolf/lede
#  REPO_BRANCH: master
#  CONFIG_FILE: .config
#  SSH_ACTIONS: false
#  UPLOAD_BIN_DIR: false
#  UPLOAD_FIRMWARE: true
#  UPLOAD_COWTRANSFER: false
#  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest #ubuntu-18.04 #
    if: github.event.repository.owner.id == github.event.sender.id
    steps:
    - name: 系统环境更新、清理空间 | Installation depends
      run: |
        sudo swapoff /swapfile
        sudo rm -rf /swapfile /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/apt/sources.list.d
        sudo -E apt-get -y purge azure-cli ghc* zulu* hhvm llvm* firefox google* dotnet* powershell openjdk* mysql* php*
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo apt-get update
        sudo apt-get -y install build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch unzip zlib1g-dev lib32gcc1 libc6-dev-i386 subversion flex uglifyjs git-core gcc-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint python rsync man-db file wget zip g++ device-tree-compiler g++-multilib antlr3 gperf python
        sudo timedatectl set-timezone "Asia/Shanghai"
        
    - name: 下载openwrt源代码、lean源代码 | Clone source code
      run: |
        git clone https://github.com/openwrt/openwrt
        #cd openwrt
        mkdir -p openwrt/package/lean
        cd openwrt/package/lean
        git init
        git remote add -f origin https://github.com/coolsnowwolf/lede
        git config core.sparsecheckout true
        echo package/lean >> .git/info/sparse-checkout
        git pull origin master
    
    - name: 修改配置信息 ｜Generate config file
      run: |
        cd openwrt
        echo "src-git lienol https://github.com/Lienol/openwrt-package" >> feeds.conf.default
        sed -i 's/wndr4300_mtdlayout=mtdparts=ar934x-nfc:256k(u-boot)ro,256k(u-boot-env)ro,256k(caldata)ro,512k(pot),2048k(language),512k(config),3072k(traffic_meter),2048k(kernel),23552k(ubi),25600k@0x6c0000(firmware),256k(caldata_backup),-(reserved)/wndr4300_mtdlayout=mtdparts=ar934x-nfc:256k(u-boot)ro,256k(u-boot-env)ro,256k(caldata),512k(pot),2048k(language),512k(config),3072k(traffic_meter),2048k(kernel),121856k(ubi),123904k@0x6c0000(firmware),256k(caldata_backup),-(reserved)/' ./target/linux/ar71xx/image/legacy.mk
        sed -i 's/root::0:0:99999:7:::/root:\$1\$wEehtjxj\$YBu4quNfVUjzfv8p\/PBo5\.:0:0:99999:7:::/' ./package/base-files/files/etc/shadow
        sed -i 's/\.disabled=1/\.disabled=0/' ./package/kernel/mac80211/files/lib/wifi/mac80211.sh
        sed -i 's/\.ssid=OpenWrt/\.ssid=stoneson/' ./package/kernel/mac80211/files/lib/wifi/mac80211.sh
        echo "net.netfilter.nf_conntrack_max=65535" >> ./package/base-files/files/etc/sysctl.conf
        
        ./scripts/feeds clean
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        make defconfig
        make prereq
        curl -fsSL https://github.com/chenxinxing/lede/raw/master/.github/config-4300 > .config.4300
        
    - name: SSH 连接，设置menuconfig
      #uses: mxschmitt/action-tmate@v1 #在退出连接后不能进行到下一个步骤，所以在实际使用中没有多少价值，只能用于 SSH 连接。
      uses: csexton/debugger-action@master #同样是通过 tmate 连接，退出连接后可持续进行下一个步骤，能更好的应用到实际项目中使用。
      
  #  - name: 上传.config
  #    uses: actions/upload-artifact@master
  #    with:
  #      name: .config
  #      path: openwrt/.config
    
    - name: Download package
      run: |
        cd openwrt && make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
    
    - name: 开始编译 | Build
      run: |
        cd openwrt
        make -j$(($(nproc) + 1)) V=s 2>&1 | tee build.log 
    
    - name: Upload build.log to WeTransfer
      #if: steps.organize.outputs.status == 'success' && env.UPLOAD_WETRANSFER == 'true' && !cancelled()
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer wet -s -p 16 --no-progress build.log 2>&1 | tee wetransfer.log
        echo "::warning file=wetransfer.com::$(cat wetransfer.log | grep https)"
        
    - name : 上传编译包｜Upload artifact
      uses: actions/upload-artifact@master
      with:
        name: OpenWrt
        path: openwrt/bin
